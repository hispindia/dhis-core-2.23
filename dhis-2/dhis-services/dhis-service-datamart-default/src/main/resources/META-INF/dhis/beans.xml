<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:aop="http://www.springframework.org/schema/aop"
  xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.1.xsd">
  
  <!-- DataMartExportStore -->

  <bean id="org.hisp.dhis.datamart.DataMartExportStore" class="org.hisp.dhis.hibernate.HibernateGenericStore">
    <property name="clazz" value="org.hisp.dhis.datamart.DataMartExport" />
    <property name="sessionFactory" ref="sessionFactory" />
  </bean>
  
  <!-- DataMartService -->

  <bean id="org.hisp.dhis.datamart.DataMartService" class="org.hisp.dhis.datamart.impl.DefaultDataMartService">
    <property name="dataMartEngine" ref="org.hisp.dhis.datamart.engine.DataMartEngine" />
    <property name="dataMartExportStore" ref="org.hisp.dhis.datamart.DataMartExportStore" />
    <property name="periodService" ref="org.hisp.dhis.period.PeriodService" />
  </bean>
  
  <!-- DataMartEngine -->

  <bean id="org.hisp.dhis.datamart.engine.DataMartEngine" class="org.hisp.dhis.datamart.engine.DefaultDataMartEngine">
    <property name="aggregatedDataValueService" ref="org.hisp.dhis.aggregation.AggregatedDataValueService" />
    <property name="aggregatedOrgUnitDataValueService" ref="org.hisp.dhis.aggregation.AggregatedOrgUnitDataValueService" />
    <property name="crossTabService" ref="org.hisp.dhis.datamart.crosstab.CrossTabService" />
    <property name="dataElementDataMart" ref="org.hisp.dhis.datamart.dataelement.DataElementDataMart" />
    <property name="indicatorDataMart" ref="org.hisp.dhis.datamart.indicator.IndicatorDataMart" />
    <property name="dataElementService" ref="org.hisp.dhis.dataelement.DataElementService" />
    <property name="indicatorService" ref="org.hisp.dhis.indicator.IndicatorService" />
    <property name="periodService" ref="org.hisp.dhis.period.PeriodService" />
    <property name="categoryService" ref="org.hisp.dhis.dataelement.DataElementCategoryService" />
    <property name="expressionService" ref="org.hisp.dhis.expression.ExpressionService" />
    <property name="organisationUnitService" ref="org.hisp.dhis.organisationunit.OrganisationUnitService" />
	<property name="organisationUnitGroupService" ref="org.hisp.dhis.organisationunit.OrganisationUnitGroupService" />
	<property name="systemSettingManager" ref="org.hisp.dhis.options.SystemSettingManager" />
  </bean>

  <bean id="internal-process-DataMart" class="org.hisp.dhis.datamart.DataMartInternalProcess" scope="prototype">
    <property name="statementManager" ref="statementManager" />
    <property name="inMemoryStatementManager" ref="inMemoryStatementManager" />
    <property name="dataMartService" ref="org.hisp.dhis.datamart.DataMartService" />
  </bean>
  
  <!-- Crosstab -->

  <bean id="org.hisp.dhis.datamart.crosstab.jdbc.CrossTabStore" class="org.hisp.dhis.datamart.crosstab.jdbc.JDBCCrossTabStore">
    <property name="statementManager" ref="inMemoryStatementManager" />
  </bean>

  <bean id="org.hisp.dhis.datamart.crosstab.CrossTabService" class="org.hisp.dhis.datamart.crosstab.DefaultCrossTabService">
    <property name="batchHandlerFactory" ref="inMemoryBatchHandlerFactory" />
    <property name="crossTabStore" ref="org.hisp.dhis.datamart.crosstab.jdbc.CrossTabStore" />
    <property name="aggregatedDataValueService" ref="org.hisp.dhis.aggregation.AggregatedDataValueService" />
    <property name="dataValueService" ref="org.hisp.dhis.datavalue.DataValueService" />
    <property name="statementManager" ref="statementManager" />
  </bean>
  
  <!-- AggregationCache -->

  <bean id="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" class="org.hisp.dhis.datamart.aggregation.cache.MemoryAggregationCache">
    <property name="organisationUnitService" ref="org.hisp.dhis.organisationunit.OrganisationUnitService" />
    <property name="periodService" ref="org.hisp.dhis.period.PeriodService" />
  </bean>
  
  <!-- DataElementAggregator -->

  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator" class="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator">
    <property name="crossTabService" ref="org.hisp.dhis.datamart.crosstab.CrossTabService" />
    <property name="aggregationCache" ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" />
  </bean>

  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.SumBoolAggregator" class="org.hisp.dhis.datamart.aggregation.dataelement.SumBoolAggregator">
    <property name="crossTabService" ref="org.hisp.dhis.datamart.crosstab.CrossTabService" />
    <property name="aggregationCache" ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" />
  </bean>

  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator" class="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator">
    <property name="crossTabService" ref="org.hisp.dhis.datamart.crosstab.CrossTabService" />
    <property name="aggregationCache" ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" />
  </bean>

  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntSingleValueAggregator" class="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntSingleValueAggregator">
    <property name="crossTabService" ref="org.hisp.dhis.datamart.crosstab.CrossTabService" />
    <property name="aggregationCache" ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" />
  </bean>

  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.AverageBoolAggregator" class="org.hisp.dhis.datamart.aggregation.dataelement.AverageBoolAggregator">
    <property name="crossTabService" ref="org.hisp.dhis.datamart.crosstab.CrossTabService" />
    <property name="aggregationCache" ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" />
  </bean>
  
  <!-- DataElementDataMart -->

  <bean id="org.hisp.dhis.datamart.dataelement.DataElementDataMart" class="org.hisp.dhis.datamart.dataelement.DefaultDataElementDataMart">
    <property name="batchHandlerFactory" ref="batchHandlerFactory" />
    <property name="inMemoryBatchHandlerFactory" ref="inMemoryBatchHandlerFactory" />
    <property name="aggregationCache" ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" />
    <property name="sumIntAggregator" ref="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator" />
    <property name="averageIntAggregator" ref="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator" />
    <property name="averageIntSingleValueAggregator" ref="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntSingleValueAggregator" />
    <property name="sumBoolAggregator" ref="org.hisp.dhis.datamart.aggregation.dataelement.SumBoolAggregator" />
    <property name="averageBoolAggregator" ref="org.hisp.dhis.datamart.aggregation.dataelement.AverageBoolAggregator" />
	<property name="statementManager" ref="inMemoryStatementManager" />
  </bean>
  
  <!-- IndicatorDataMart -->

  <bean id="org.hisp.dhis.datamart.indicator.IndicatorDataMart" class="org.hisp.dhis.datamart.indicator.DefaultIndicatorDataMart">
    <property name="expressionService" ref="org.hisp.dhis.expression.ExpressionService" />
    <property name="aggregationCache" ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache" />
    <property name="systemSettingManager" ref="org.hisp.dhis.options.SystemSettingManager" />
    <property name="crossTabService" ref="org.hisp.dhis.datamart.crosstab.CrossTabService" />
	<property name="constantService" ref="org.hisp.dhis.constant.ConstantService" />
    <property name="batchHandlerFactory" ref="batchHandlerFactory" />
	<property name="statementManager" ref="inMemoryStatementManager" />
  </bean>
    
  <!-- DeletionHandler -->

  <bean id="org.hisp.dhis.datamart.DataMartExportDeletionHandler" class="org.hisp.dhis.datamart.DataMartExportDeletionHandler">
    <property name="dataMartService" ref="org.hisp.dhis.datamart.DataMartService" />
  </bean>
  
  <!-- DeletionManager -->

  <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="targetObject" ref="deletionManager" />
    <property name="targetMethod" value="addDeletionHandlers" />
    <property name="arguments">
      <list>
        <list>
          <ref local="org.hisp.dhis.datamart.DataMartExportDeletionHandler" />
        </list>
      </list>
    </property>
  </bean>
  
  <!-- Deletion AOP definitions -->

  <aop:config>

    <aop:aspect ref="deletionInterceptor">
      <aop:before pointcut="execution( * org.hisp.dhis.datamart.DataMartService.deleteDataMartExport(..) )"
        method="intercept" />
    </aop:aspect>

    <aop:aspect ref="inMemoryStatementInterceptor">
      <aop:around pointcut="execution( * org.hisp.dhis.datamart.DataMartService.export(..) )" method="intercept" />
    </aop:aspect>

  </aop:config>

</beans>
