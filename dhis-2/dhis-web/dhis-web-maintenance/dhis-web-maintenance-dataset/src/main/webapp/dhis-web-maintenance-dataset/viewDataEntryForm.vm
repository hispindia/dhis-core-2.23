<script type="text/javascript">
    var stat = ('$!dataEntryForm') ? "EDIT" : "ADD";
    var dataEntryFormId = -1;
    var i18n_confirm_delete = '$encoder.jsEscape( $i18n.getString( "dataentryform_confirm_delete" ) , "'" )';
    	
    #if($!dataEntryForm)
        dataEntryFormId = $dataEntryForm.id;
    #end    
  
	var autoSave = '$!autoSave';
	
	
	jQuery(document).ready(	function(){
			validation( 'saveDataEntryForm', function(){
				autoSave = false;
				validateDataEntryForm();
			} );	
						
			jQuery("#dataElementSelection").resizable({
				minHeight:210,
				minWidth:400,
				width:400,
				alsoResize: "#dataElementList"				
			});			
			
			jQuery("#dataElementSelection").draggable({
				handle:'h3'
			});

			
			leftBar.hideAnimated();
			
			select( 1 );

	});
	
	
</script>

<style>

#dataElementSelection { 
	padding: 0.5em; 
	position:fixed;
	top:80px;
	left:500px;
	z-index:999999;
	font-size:10pt;
	
}
#dataElementSelection h3 {
	font-size:10pt;
	color:#FFFFFF;
	cursor:move;
	text-align: center; 
	margin: 0;
}

#dataElementSelection tr{
	cursor:default;	
}

#dataElementSelection tr.selected{
	background-color:#2B0AAF;
	color:#FFFFFF;
}

#dataElementList{
	margin-top:5px;
}

#message_{
	display:block;
	color:red;	
}

</style>


<h3>$i18n.getString( "dataentryform_management" ) #openHelp( "custom_forms" )</h3>

<form id="saveDataEntryForm" name="saveDataEntryForm" action="saveDataEntryForm.action" method="post">
  <table id="detailsList">
    <col/> ## Labels
    <col/> ## Input
    <thead>
      <tr>
        <th colspan="2">$i18n.getString( "dataentryform_details" )</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><label>$i18n.getString( "name" ) <em title="$i18n.getString( 'required' )" class="required">*</em></label></td>
        <td><input type="text" id="nameField" name="nameField" value='$!dataEntryForm.name' style="width:20em" maxlength="100" class="{validate:{required:true,minlength:4}}"/></td>
      </tr>
      <tr>
        <td><label>$i18n.getString( "dataset" ) <em title="$i18n.getString( 'required' )" class="required">*</em></label></td>
        <td><input type="text" value="$dataSet.name" style="width:20em" disabled /></td>
      </tr>
      <tr>
        <td colspan="2">&nbsp;</td>
      </tr>
    </tbody>
  </table>
    
   <table width="100%">      
      <tr>
        <th>$i18n.getString( "dataentryform_design" )</th>
      </tr>
      <tr>
        <td>
			$editorManager.create( "designTextarea", "100%", "400" )
		</td>
      </tr>
      <tr>
      <td>
      <table id="cde_buttontable">
      <tr>
        <td>
		  <input type="button" name="save" value="$i18n.getString( 'save' )" onclick="autoSave = true; validateDataEntryForm(); autoSave = '$!autoSave';"/>
          <input type="submit" name="saveClose" value="$i18n.getString( 'save_close' )"/>
          <input type="button" name="cancel" value="$i18n.getString( 'cancel' )" onclick="window.location.href='dataSet.action'"/>
        </td>
        <td id="cde_deletebuttoncell">
          <input type="button" id='delete' name="delete" value="$i18n.getString( 'delete' )" onclick="removeDataEntryForm( '$dataSet.id', '$dataEntryForm.id', '$dataEntryForm.name' )"/>
		  <script>
			if(stat == "EDIT")
			{
				enable('delete');
			}
			else
			{
				disable('delete');
			}
		  </script>
        </td>
        </tr>
		<tr><td><span id="message"></span></td></tr>
        </table>
        </td>
      </tr>
    </tbody>
  </table>
  <input type="hidden" name="dataSetIdField" id="dataSetIdField" value="$dataSet.id" />
</form>

<div id="dataElementSelection" class="ui-widget-content">
<h3 class="ui-widget-header"><b>$i18n.getString( 'dataelement' )</b></h3>
	<input type="text" style="width:440px" onkeyup="filterValues( this.value, 1 )"/>
	<div id="dataElementList" style="height:150px;overflow:auto;border:1px solid #7AAED5">
	<table width="100%">
		<tbody id="list">
		#foreach( $operand in $operands )
			<tr id="tr$velocityCount" onclick="select($velocityCount)" ondblclick="insertDataElement()">				
				<td>$encoder.htmlEncode( $operand.operandName )<input type="hidden" id="json_$velocityCount" value='$operand.toJSON()'/></td>
			</tr>						
		#end
		</tbody>
	</table>
	</div>
	<table>
		<tr>
			<td>
				<b>$i18n.getString( "view_as" )</b><br>
				<select name="viewBySelector" id="viewBySelector" style="width:150px">		
					<option value="deid">$i18n.getString( "id" )</option>
					<option value="dename">$i18n.getString( "name" )</option>
					<option value="deshortname" selected>$i18n.getString( "short_name" )</option> 	
				</select>
				<input type="button" value="Insert" onclick="insertDataElement()"/>
			</td>
			<td>
				<span id="message_"></span>
			</td>
		</tr>
	</table>	
</div>

<script>
	var i18n_save_success = '$encoder.jsEscape( $i18n.getString( "save_success" ) , "'" )';
	var i18n_dataelement_is_inserted = '$encoder.jsEscape( $i18n.getString( "dataelement_is_inserted" ) , "'" )';
	
	var t;
	var timer_is_on=0;
	
	if('$autoSave' == 'true'){
		if (!timer_is_on)
		  {
			  timer_is_on=1;
			  timedCount();
		  }
	}
	
	function timedCount()
	{
		validateDataEntryForm();
		t=setTimeout("timedCount()", 20000);//1000 -> 1s
		byId( 'message' ).style.display = 'none';
	}	

var selected = null;

function select( id )
{
	if( selected != null )
	{
		jQuery("#tr" + selected ).removeClass( "selected");
	}
	
	jQuery("#tr" + id ).addClass( "selected");
	
	selected = id;
}


function insertDataElement()
{
	var oEditor = FCKeditorAPI.GetInstance('designTextarea') ;
	var viewByValue = getFieldValue( 'viewBySelector' );
	
	var json = JSON.parse( jQuery("#json_" + selected ).val() );
	
	var dataElementId = json.dataElement.id;
	var dataElementName = json.dataElement.name;
	var dataElementType = json.dataElement.type;
	var optionComboName = json.optionCombo.name;
	var optionComboId = json.optionCombo.id;
	
	if(viewByValue == "deid") dispName = "[ " + dataElementId;
	else if (viewByValue == "deshortname") dispName = "[ " + json.dataElement.shortName;
	else dispName = "[ " + json.dataElement.name;
	
	var titleValue = "-- " + dataElementId + ". " 
					+ dataElementName + " " 
					+ optionComboId + ". " 
					+ optionComboName + " (" 
					+ dataElementType + ") --";
					
	var displayName = dispName + " - " + optionComboName + " ]";
	var dataEntryId = "value[" + dataElementId + "].value:value[" + optionComboId + "].value";
	var boolDataEntryId = "value[" + dataElementId + "].value:value[" + optionComboId + "].value";
	
	viewByValue = "@@" + viewByValue + "@@";
	
	var id = "";
	var html = "";
	
	if (dataElementType == "bool")
	{
		id = boolDataEntryId;
		html = "<input title=\"" + titleValue + "\" view=\""+viewByValue+"\" value=\"" + displayName + "\" id=\""+ boolDataEntryId +"\" style=\"width:4em;text-align:center\"/>";
		
		
	}else 
	{	
		id = dataEntryId;
		html = "<input title=\"" + titleValue + "\" view=\""+viewByValue+"\" value=\"" + displayName + "\" id=\"" + dataEntryId + "\" style=\"width:4em;text-align:center\"/>" ;			
	}	
	
	if( checkExisted( id ) )
	{		
		jQuery( "#message_").html( "<b>" + i18n_dataelement_is_inserted + "</b>" );
		return;
	}else{
		jQuery( "#message_").html("");
	}
	
	oEditor.InsertHtml( html );
	
}

function checkExisted( id )
{	
	var result = false;
	var html = FCKeditorAPI.GetInstance('designTextarea').GetHTML();
	var input = jQuery( html ).find("select, :text");
	input.each( function(i, item){		
		if( id == item.id ) result = true;		
	});
	
	return result;
}

	
</script>
